name: CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
    # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build-linux:
    name: Build (Linux)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install gperf desktop-file-utils libgtk-3-dev libgtk-4-dev libjudy-dev libgirepository1.0-dev
      - name: Install meson
        run: pip install meson ninja
      - name: Setup meson build
        run: meson setup build
      - name: Compile GTKWave
        run: meson compile -C build
      - name: Run tests
        run: meson test -C build -v

  build-linux-riscv:
    name: Build (Linux-RV)
    runs-on: ubuntu-latest
    # Tighten permissions granted to the GITHUB_TOKEN
    permissions:
      packages: write # for uraimo/run-on-arch-action to cache docker images
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Cross-Compile Support on Ubuntu
        uses: cyberjunk/gha-ubuntu-cross@v4
        with:
          arch: riscv64
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install gperf desktop-file-utils
          pip install meson ninja
      - name: Install cross dependencies
        run: |
          sudo apt-get -y install libgtk-4-dev:riscv64 libjudy-dev:riscv64 libgirepository1.0-dev:riscv
      - name: Setup meson build
        run: meson setup buildCross --cross-file=.github/workflows/riscv64-linux-gnu.txt
      - name: Compile GTKWave
        run: meson compile -C buildCross

  build-macos:
    name: Build (macOS)
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: brew install meson ninja gtk+3 gtk4 gtk-mac-integration gobject-introspection shared-mime-info desktop-file-utils
      - name: Setup xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 15.3.0
      - name: Setup meson build
        run: meson setup build
      - name: Compile GTKWave
        run: meson compile -C build
      - name: Run tests
        run: meson test -C build -v
